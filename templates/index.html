{% extends 'base.html' %} {% block content %}

<nav>
    <div></div>
    <div class="logo-container">
        <img src="{{ url_for('static', filename='images/palate_pic.png') }}" alt="Palate Logo" />
        <h1>&nbsp;palate</h1>
    </div>
    <a style='color: inherit; text-decoration: none' href="/preferences"><div class="user-options-container"><i class="fa fa-gear"></i></div></a>
</nav>

<section>

    <div class="user-results" id="restaurantCards">
        <div class="loading" id="loading" style="display: none;">
            <p>Loading...</p>
        </div>
    </div>


    <div class="user-groups">
        <div class="selected-users">
        </div>
        <div class="user-groups-options">
            <i class="fa fa-plus"></i>
            <i class="fa fa-save"></i>
        </div>
        <div class="refresh-options">
            <button type="button" class="button">
                <i class="fa fa-rotate-right"></i>
                <span>&nbsp;Refresh</span>
            </button>
        </div>
    </div>

    <script>
        const refreshButton = document.querySelector('.refresh-options button');
        refreshButton.addEventListener('click', generate);

        const addButton = document.querySelector('.user-groups-options .fa-plus');
        addButton.addEventListener('click', promptAddUser);

        let currentMembers = []
        let currentPreferences = {}
        window.onload = async function() {
            const user = await getCurrentUser();
            createUserCard(user.name, user.avatar);
            currentMembers.push(user.user_id);
            currentPreferences = await getAllPreferences()
            console.log(currentPreferences);
        }

        function startLoading() {
            // clear out previous results
            const restaurantCardsDiv = document.getElementById("restaurantCards");
            restaurantCardsDiv.innerHTML = ""; // Clear previous cards

            // create loading div
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.id = 'loading';
            loading.innerHTML = `<p>Loading...</p>`;
            restaurantCardsDiv.appendChild(loading);

            loading.style.display = 'block';
        }

        function stopLoading() {
            const loading = document.getElementById('loading');
            loading.style.display = 'none';
        }

        async function generate() {
            startLoading();
            let preferences = await getAllPreferences();
            const restaurantData = JSON.stringify(await callFoodApi(preferences), null, 4);
            console.log(restaurantData);
            await callTextApi(restaurantData, preferences);
            stopLoading();
        }

        function getMeters(miles) {
            return Math.round(miles*1609.344);
        }

        async function promptAddUser() {
            const name = prompt("Enter the name of the user you would like to add:");
            const user = await searchUsers(name);
            if (user.length === 0) {
                alert("User not found.");
            } else {
                addUser(user);
            }
        }

        async function addUser(user) {
            currentMembers.push(user[0].user_id);
            createUserCard(user[0].name, user[0].avatar);
            console.log(await getAllPreferences());
        }

        async function getCurrentUser() {
            const response = await fetch("/api/user", {
                method: "GET",
                headers: {
                "Content-Type": "application/json",
                },
            })
            return await response.json();
        }

        async function searchUsers(name) {
            const response = await fetch(`/api/user/search/${name}`, {
                method: "GET",
                headers: {
                "Content-Type": "application/json",
                },
            })
            return await response.json();
        }

        function createUserCard (name, img) {
            const selectedUsers = document.querySelector('.selected-users');
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.innerHTML = `
                <div class="user-card-image" style="background-image: url(${img});"></div>
                <div class="user-card-name"><p>${name}</p></div>
            `;
            selectedUsers.appendChild(userCard);
        }

        function getPreferredPrice(price) {
            if (price === "$") {
                return "1";
            } else if (price === "$$") {
                return "1,2";
            } else if (price === "$$$") {
                return "1,2,3";
            } else if (price === "$$$$") {
                return "1,2,3,4";
            }
        }

        async function callFoodApi(prefs) {
            //todo: use user location
            userLocation = "berkeley, ca";
            // Call Yelp API
            const url = `https://api.yelp.com/v3/businesses/search?term='restauraunt'&categories=${prefs.preferred_cuisine}&location=${userLocation}&radius=${getMeters(prefs.max_distance)}&price=${getPreferredPrice(prefs.preferred_price)}&limit=30`;
            
            const response = await fetch(`/api/yelp_search?url=${encodeURIComponent(url)}`)
            return await response.json();
        }

        async function getAllPreferences() {
            let preferences = {}
            for (user of currentMembers) {
                const response = await fetch(`/api/preferences/${user}`, {
                    method: "GET",
                    headers: {
                    "Content-Type": "application/json",
                    },
                })
                let output = await response.json();
                output = output.preferences;
                // min distance
                if (!preferences.max_distance || parseInt(output.max_distance) < parseInt(preferences.max_distance)) {
                    preferences.max_distance = output.max_distance;
                }
                // price
                let price = getPreferredPrice(output.preferred_price ?? "")
                if (!preferences.preferred_price || price.length < preferences.preferred_price.length) {
                    preferences.preferred_price = output.preferred_price;
                }
                
                output.preferred_cuisine = output.preferred_cuisine.map(cuisine => cuisine.toLowerCase());
                if (!preferences.preferred_cuisine) {
                    preferences.preferred_cuisine = output.preferred_cuisine
                } else {
                    preferences.preferred_cuisine = preferences.preferred_cuisine.concat(output.preferred_cuisine);
                }
                preferences.preferred_cuisine = [...new Set(preferences.preferred_cuisine)];
                // preferences.preferred_cuisine = preferences.preferred_cuisine.slice(0, 3);
                // append dietary restrictions
                if (!preferences.dietary_restrictions) {
                    preferences.dietary_restrictions = output.dietary_restrictions;
                } else {
                    preferences.dietary_restrictions = preferences.dietary_restrictions.concat(output.dietary_restrictions);
                }
                // append other
                if (!preferences.other) {
                    preferences.other = "User: " + output.other;
                } else {
                    preferences.other = preferences.other + "\nUser: " + output.other;
                }
                

            }
            return preferences;
        }

        async function getPreferences(id) {
            const response = await fetch(`/api/preferences/${id}`, {
                method: "GET",
                headers: {
                "Content-Type": "application/json",
                },
            })
            return await response.json();
        }
        
        async function callTextApi(restaurantData, prefs) {
            candidate_restaurants_list_str = restaurantData

            price_preference = prefs.preferred_price
            cuisine_preference = prefs.preferred_cuisine
            dietary_preference = prefs.dietary_restrictions
            radius = getMeters(prefs.max_distance)
            other_preference = prefs.other

            // Use the same candidate_restaurants_list variable here
            if (!candidate_restaurants_list_str || candidate_restaurants_list_str.split(/\s+/).length <= 100) {
                console.error('candidate_restaurants_list_str is null or contains less than 100 tokens');
                return; // Exit the function if candidate_restaurants_list_str is null or contains less than 100 tokens
            }

            // Call Text API
            const response = await fetch(
                'https://noggin.rea.gent/continuous-antelope-3807',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer rg_v1_ooqoohk93vi2bhc0xrpye6m4tkwg7s993vfz_ngk',
                    },
                    body: JSON.stringify({
                        "location": userLocation,
                        "price_preference": price_preference,
                        "cuisine_preference": cuisine_preference,
                        "dietary_preference": dietary_preference,
                        "candidate_restaurant_list": candidate_restaurants_list_str,
                        "radius": radius,
                        "other_preference": other_preference
                    }),
                }
            );
            const textResponse = await response.text();

            // Parse text API response and display top 3 restaurants
            const top3Restaurants = parseTop3Restaurants(textResponse);
            displayRestaurantCards(top3Restaurants);
        }

        function parseTop3Restaurants(response) {
            const restaurants = response.split('\n');
            return restaurants.map(restaurant => {
                const idMatch = restaurant.match(/ID: "([^"]*)"/);
                const nameMatch = restaurant.match(/Name: "([^"]*)"/);
                const addressMatch = restaurant.match(/Address: "([^"]*)"/);
                const urlMatch = restaurant.match(/URL: "([^"]*)"/);
                const imgurlMatch = restaurant.match(/ImageURL: "([^"]*)"/);
                const ratingMatch = restaurant.match(/Rating: "([^"]*)"/);
                const rcountMatch = restaurant.match(/ReviewCount: "([^"]*)"/);
                const reasonMatch = restaurant.match(/Reason: (.*)/);
                
                // Check if all required fields are present
                if (idMatch || nameMatch || addressMatch || urlMatch || imgurlMatch || ratingMatch || rcountMatch || reasonMatch) {
                    const id = idMatch ? idMatch[1] : "";
                    const name = nameMatch ? nameMatch[1] : "";
                    const address = addressMatch ? addressMatch[1] : "";
                    const url = urlMatch ? urlMatch[1] : "";
                    const imgurl = imgurlMatch ? imgurlMatch[1] : "";
                    const rating = ratingMatch ? ratingMatch[1] : "";
                    const rcount = rcountMatch ? rcountMatch[1] : "";
                    const reason = reasonMatch ? reasonMatch[1] : "";
                    return { id: id, name: name, address: address, url: url, imgurl: imgurl, rating: rating, rcount: rcount, reason: `Reason: ${reason}` };
                } else {
                    return null;
                }
            }).filter(restaurant => restaurant !== null); // Remove entries with missing fields
        }

        function displayRestaurantCards(restaurants) {
            const restaurantCardsDiv = document.getElementById("restaurantCards");

            restaurants.forEach((restaurant, index) => {
                const card = document.createElement("div");
                card.className = "result-card";
                card.style.height = "500px"
                card.innerHTML = `
                    <div class="result-card-image" style="background-image: url(${restaurant.imgurl});"><i class="fa fa-star"></i></div>
                    <div class="result-card-desc">
                        <h1><a target='_blank' style='color: inherit;' href="${restaurant.url}">${restaurant.name}</a> </h1>
                        <h2>${restaurant.address}</h2>
                        <div class="stars-container">
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <p class="stars-counter">${restaurant.rating} (${restaurant.rcount})</p>
                </div>
                        <h3>${restaurant.reason}</h3>
                    </div>
                `;
                restaurantCardsDiv.appendChild(card);
            });
        }
    </script>

{% endblock %}
