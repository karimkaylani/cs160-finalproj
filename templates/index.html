{% extends 'base.html' %} {% block content %}

<nav>
    <div></div>
    <div class="logo-container">
        <img src="{{ url_for('static', filename='images/palate_pic.png') }}" alt="Palate Logo" />
        <h1>&nbsp;palate</h1>
    </div>
    <a href="/preferences"><div class="user-options-container"><p>Hi, {{ user }}!</p>&nbsp;<i class="fa fa-gear"></i></div></a>
</nav>

<section>

    <div class="user-results">
        <div class="result-card">
            <div class="result-card-image" style="background-image: url(../static/images/donuts.jpg);"><i class="fa fa-star"></i></div>
            <div class="result-card-desc">
                <h1>Jupiter</h1>
                <h2>2181 Shattuck Ave</h2>
                <h3>Pizza</h3>
                <div class="stars-container">
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <p class="stars-counter">(60)</p>
                </div>
            </div>
        </div>
        
        <div class="result-card">
            <div class="result-card-image" style="background-image: url(../static/images/donuts.jpg);"><i class="fa fa-star"></i></div>
            <div class="result-card-desc">
                <h1>Jupiter</h1>
                <h2>2181 Shattuck Ave</h2>
                <h3>Pizza</h3>
                <div class="stars-container">
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <p class="stars-counter">(60)</p>
                </div>
            </div>
        </div>

        <div class="result-card">
            <div class="result-card-image" style="background-image: url(../static/images/donuts.jpg);"><i class="fa fa-star"></i></div>
            <div class="result-card-desc">
                <h1>Jupiter</h1>
                <h2>2181 Shattuck Ave</h2>
                <h3>Pizza</h3>
                <div class="stars-container">
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <p class="stars-counter">(60)</p>
                </div>
            </div>
        </div>
    </div>


    <div class="user-groups">
        <div class="selected-users">
            <div class="user-card">
                <div class="user-card-image" style="background-image: url(../static/images/sarah.jpeg);"></div>
                <div class="user-card-name"><p>Sarah Jones</p></div>
            </div>
            <div class="user-card">
                <div class="user-card-image" style="background-image: url(../static/images/sarah.jpeg);"></div>
                <div class="user-card-name"><p>Sarah Jones</p></div>
            </div>
        </div>
        <div class="user-groups-options">
            <i class="fa fa-plus"></i>
            <i class="fa fa-save"></i>
        </div>
        <div class="refresh-options">
            <button type="button" class="button">
                <i class="fa fa-rotate-right"></i>
                <span>&nbsp;Refresh</span>
            </button>
        </div>
    </div>
    
    <div class="user-results" id="restaurantCards" position=absolute></div>

<section>

<div position=absolute>

    <button onclick="callFoodApi()">Call food API</button>
    <button onclick="callTextApi()">Call Text API</button>

    <div class="result-card" id="textApiResult">
        <h2>Text API Result</h2>
        <textarea rows="20" id="text-result" readonly></textarea>
    </div>

    <div class="result-card" id="foodApiResult" style="height: 800px;">
        <h3>Food API Result</h3>
        <p rows="100" id="food-result" class="result-text" readonly></p>
    </div>

</section>


    <script>

        let terms, userLocation, price_preference, cuisine_preference, dietary_preference;
// Declare global variables
        let candidate_restaurants_list_str;

        // Your other functions

        function getMeters(miles) {
            return Math.round(miles*1609.344);
        }

        function getPrefferedPrice(price) {
            if (price === "$") {
                return "1";
            } else if (price === "$$") {
                return "1,2";
            } else if (price === "$$$") {
                return "1,2,3";
            } else if (price === "$$$$") {
                return "1,2,3,4";
            }
        }

        async function callFoodApi() {
            const foodApiResult = document.getElementById("food-result");
            foodApiResult.value = ""; // Clear previous cards

            //todo: get preference variables
            let prefs = await getPreferences();
            prefs = prefs.preferences;
            terms = "dessert";
            userLocation = "berkeley, ca";

            // Call Yelp API
            const apiKey = 'a0Wnk-q_xlBU4KO0TF-JB-4qmMB6QoLsMhIecm5-0Jp9p3H-1y1hJwYfVO_Nc26P6OEKgncpT_TL5Csgvnf4CSeGagYCzQcKx9EDkMaUx21qte9RnFFwmQVEUAMeZnYx';
            const url = `https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?term=${prefs.preferred_cuisine}&location=${userLocation}&price=${getPrefferedPrice(prefs.preferred_price)}&open_now=true&limit=10`;
            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const candidate_restaurants_list = data.businesses.slice(0, 10);  //using 5 for lower cost while testing
                const candidate_restaurants_list_str = JSON.stringify(candidate_restaurants_list, null, 4);
                foodApiResult.innerText = candidate_restaurants_list_str;
                console.log(candidate_restaurants_list)
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        async function getPreferences() {
            const response = await fetch("/api/preferences", {
                method: "GET",
                headers: {
                "Content-Type": "application/json",
                },
            })
            return await response.json();
        }
        
        async function callTextApi() {
            candidate_restaurants_list_str = document.getElementById("food-result").innerText;
            //getPreferences();

            //todo: use ALL group preferences
            let prefs = await getPreferences();
            prefs = prefs.preferences;
            price_preference = prefs.preferred_price
            cuisine_preference = prefs.preferred_cuisine
            dietary_preference = prefs.dietary_preference
            radius = prefs.max_distance

            // Use the same candidate_restaurants_list variable here
            if (!candidate_restaurants_list_str || candidate_restaurants_list_str.split(/\s+/).length <= 100) {
                console.error('candidate_restaurants_list_str is null or contains less than 100 tokens');
                return; // Exit the function if candidate_restaurants_list_str is null or contains less than 100 tokens
            }

            // Call Text API
            const response = await fetch(
                'https://noggin.rea.gent/continuous-antelope-3807',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer rg_v1_ooqoohk93vi2bhc0xrpye6m4tkwg7s993vfz_ngk',
                    },
                    body: JSON.stringify({
                        "location": userLocation,
                        "price_preference": price_preference,
                        "cuisine_preference": cuisine_preference,
                        "dietary_preference": dietary_preference,
                        "candidate_restaurant_list": candidate_restaurants_list_str,
                        "radius": radius
                    }),
                }
            );
            const textResponse = await response.text();
            document.getElementById("text-result").value = textResponse;
            console.log(textResponse)

            // Parse text API response and display top 3 restaurants
            const top3Restaurants = parseTop3Restaurants(textResponse);
            displayRestaurantCards(top3Restaurants);
        }

        function parseTop3Restaurants(response) {
            const restaurants = response.split('\n');
            return restaurants.map(restaurant => {
                const idMatch = restaurant.match(/ID: "([^"]*)"/);
                const nameMatch = restaurant.match(/Name: "([^"]*)"/);
                const addressMatch = restaurant.match(/Address: "([^"]*)"/);
                const urlMatch = restaurant.match(/URL: "([^"]*)"/);
                const imgurlMatch = restaurant.match(/ImageURL: "([^"]*)"/);
                const ratingMatch = restaurant.match(/Rating: "([^"]*)"/);
                const rcountMatch = restaurant.match(/ReviewCount: "([^"]*)"/);
                const reasonMatch = restaurant.match(/Reason: (.*)/);
                
                // Check if all required fields are present
                if (idMatch && nameMatch && addressMatch && urlMatch && reasonMatch) {
                    const id = idMatch[1];
                    const name = nameMatch[1];
                    const address = addressMatch[1];
                    const url = urlMatch[1];
                    const imgurl = imgurlMatch ? imgurlMatch[1] : "";
                    const rating = ratingMatch[1];
                    const rcount = rcountMatch[1];
                    const reason = reasonMatch[1];
                    return { id: id, name: name, address: address, url: url, imgurl: imgurl, rating: rating, rcount: rcount, reason: `Reason: ${reason}` };
                } else {
                    // If any required field is missing, return null
                    return null;
                }
            }).filter(restaurant => restaurant !== null); // Remove entries with missing fields
        }



        function displayRestaurantCards(restaurants) {
            const restaurantCardsDiv = document.getElementById("restaurantCards");
            restaurantCardsDiv.innerHTML = ""; // Clear previous cards

            restaurants.forEach((restaurant, index) => {
                const card = document.createElement("div");
                card.className = "result-card";
                card.style.height = "500px"
                card.innerHTML = `
                    <div class="result-card-image" style="background-image: url(${restaurant.imgurl});"><i class="fa fa-star"></i></div>
                    <div class="result-card-desc">
                        <h1>No.${index + 1} --- <a href="${restaurant.url}">${restaurant.name}</a> </h1>
                        <h2>${restaurant.address}</h2>
                        <div class="stars-container">
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <p class="stars-counter">${restaurant.rating} (${restaurant.rcount})</p>
                </div>
                        <h3>${restaurant.reason}</h3>
                    </div>
                `;
                restaurantCardsDiv.appendChild(card);
            });
        }
    </script>

{% endblock %}
