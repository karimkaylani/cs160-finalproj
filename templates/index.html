{% extends 'base.html' %} {% block content %}

<nav>
    <div></div>
    <div class="logo-container">
        <img src="{{ url_for('static', filename='images/palate_pic.png') }}" alt="Palate Logo" />
        <h1>&nbsp;palate</h1>
    </div>
    <a style='color: inherit; text-decoration: none' href="/preferences"><div class="user-options-container"><i class="fa fa-gear"></i></div></a>
</nav>

<section>

    <div class="user-results" id="restaurantCards">     
    </div>


    <div class="user-groups">
        <div class="selected-users">
            <div class="user-card">
                <div class="user-card-image" style="background-image: url('{{ user_photo }}')";></div>
                <div class="user-card-name"><p>{{ user_name }}</p></div>
            </div>
        </div>
        <div class="user-groups-options">
            <i class="fa fa-plus"></i>
            <i class="fa fa-save"></i>
        </div>
        <div class="refresh-options">
            <button type="button" class="button">
                <i class="fa fa-rotate-right"></i>
                <span>&nbsp;Refresh</span>
            </button>
        </div>
    </div>
    
    
    <div class="user-results" id="restaurantCards" position=absolute></div>


    <div class="user-results" id="restaurantCards" position=absolute></div>


    <script>
        const refreshButton = document.querySelector('.refresh-options button');
        refreshButton.addEventListener('click', generate);


        async function generate() {
            const restaurantData = await callFoodApi();
            await callTextApi(restaurantData);
        }

        function getMeters(miles) {
            return Math.round(miles*1609.344);
        }

        async function getCurrentUser() {
            const response = await fetch("/api/user", {
                method: "GET",
                headers: {
                "Content-Type": "application/json",
                },
            })
            return await response.json();
        }

        function createUserCard (name, img) {
            const selectedUsers = document.querySelector('.selected-users');
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.innerHTML = `
                <div class="user-card-image" style="background-image: url(${img});"></div>
                <div class="user-card-name"><p>${name}</p></div>
            `;
            selectedUsers.appendChild(userCard);
        }

        function getPrefferedPrice(price) {
            if (price === "$") {
                return "1";
            } else if (price === "$$") {
                return "1,2";
            } else if (price === "$$$") {
                return "1,2,3";
            } else if (price === "$$$$") {
                return "1,2,3,4";
            }
        }

        async function getYelpResults(url) {
            const response = await fetch(`/api/yelp_search?url=${encodeURIComponent(url)}`)
            if (response.ok) {
                let output = await response.json();
                console.log('Loaded from cache!')
                return JSON.stringify(output, null, 4);
            }
            const apiKey = 'a0Wnk-q_xlBU4KO0TF-JB-4qmMB6QoLsMhIecm5-0Jp9p3H-1y1hJwYfVO_Nc26P6OEKgncpT_TL5Csgvnf4CSeGagYCzQcKx9EDkMaUx21qte9RnFFwmQVEUAMeZnYx';
            return fetch(url, {
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const candidate_restaurants_list = data.businesses.slice(0, 10);  //using 5 for lower cost while testing
                setYelpResults(url, candidate_restaurants_list);
                const candidate_restaurants_list_str = JSON.stringify(candidate_restaurants_list, null, 4);
                return candidate_restaurants_list_str;
            })
            .catch(error => {
                console.error('Error:', error);
                return "";
            });
        }

        async function setYelpResults(url, res) {
            let data = {}
            data.url = url
            data.results = res
            const response = await fetch("/api/yelp_search", {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            })
            let output = await response.json();
        }

        async function callFoodApi() {
            //todo: use user location
            let prefs = await getPreferences();
            prefs = prefs.preferences;
            userLocation = "berkeley, ca";

            // Call Yelp API
            const url = `https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?term=${prefs.preferred_cuisine}&location=${userLocation}&price=${getPrefferedPrice(prefs.preferred_price)}&open_now=true&limit=10`;

            return await getYelpResults(url);
        }

        async function getPreferences() {
            const response = await fetch("/api/preferences", {
                method: "GET",
                headers: {
                "Content-Type": "application/json",
                },
            })
            return await response.json();
        }
        
        async function callTextApi(restaurantData) {
            candidate_restaurants_list_str = restaurantData

            //todo: use ALL group preferences
            let prefs = await getPreferences();
            prefs = prefs.preferences;
            price_preference = prefs.preferred_price
            cuisine_preference = prefs.preferred_cuisine
            dietary_preference = prefs.dietary_restrictions
            radius = prefs.max_distance
            other_preference = prefs.other

            // Use the same candidate_restaurants_list variable here
            if (!candidate_restaurants_list_str || candidate_restaurants_list_str.split(/\s+/).length <= 100) {
                console.error('candidate_restaurants_list_str is null or contains less than 100 tokens');
                return; // Exit the function if candidate_restaurants_list_str is null or contains less than 100 tokens
            }

            // Call Text API
            const response = await fetch(
                'https://noggin.rea.gent/continuous-antelope-3807',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer rg_v1_ooqoohk93vi2bhc0xrpye6m4tkwg7s993vfz_ngk',
                    },
                    body: JSON.stringify({
                        "location": userLocation,
                        "price_preference": price_preference,
                        "cuisine_preference": cuisine_preference,
                        "dietary_preference": dietary_preference,
                        "candidate_restaurant_list": candidate_restaurants_list_str,
                        "radius": radius,
                        "other_preference": other_preference
                    }),
                }
            );
            const textResponse = await response.text();

            // Parse text API response and display top 3 restaurants
            const top3Restaurants = parseTop3Restaurants(textResponse);
            displayRestaurantCards(top3Restaurants);
        }

        function parseTop3Restaurants(response) {
            const restaurants = response.split('\n');
            return restaurants.map(restaurant => {
                const idMatch = restaurant.match(/ID: "([^"]*)"/);
                const nameMatch = restaurant.match(/Name: "([^"]*)"/);
                const addressMatch = restaurant.match(/Address: "([^"]*)"/);
                const urlMatch = restaurant.match(/URL: "([^"]*)"/);
                const imgurlMatch = restaurant.match(/ImageURL: "([^"]*)"/);
                const ratingMatch = restaurant.match(/Rating: "([^"]*)"/);
                const rcountMatch = restaurant.match(/ReviewCount: "([^"]*)"/);
                const reasonMatch = restaurant.match(/Reason: (.*)/);
                
                // Check if all required fields are present
                if (idMatch && nameMatch && addressMatch && urlMatch && reasonMatch) {
                    const id = idMatch ? idMatch[1] : "";
                    const name = nameMatch ? nameMatch[1] : "";
                    const address = addressMatch ? addressMatch[1] : "";
                    const url = urlMatch ? urlMatch[1] : "";
                    const imgurl = imgurlMatch ? imgurlMatch[1] : "";
                    const rating = ratingMatch ? ratingMatch[1] : "";
                    const rcount = rcountMatch ? rcountMatch[1] : "";
                    const reason = reasonMatch ? reasonMatch[1] : "";
                    return { id: id, name: name, address: address, url: url, imgurl: imgurl, rating: rating, rcount: rcount, reason: `Reason: ${reason}` };
                } else {
                    // If any required field is missing, return null
                    return null;
                }
            }).filter(restaurant => restaurant !== null); // Remove entries with missing fields
        }

        function displayRestaurantCards(restaurants) {
            const restaurantCardsDiv = document.getElementById("restaurantCards");
            restaurantCardsDiv.innerHTML = ""; // Clear previous cards

            restaurants.forEach((restaurant, index) => {
                const card = document.createElement("div");
                card.className = "result-card";
                card.style.height = "500px"
                card.innerHTML = `
                    <div class="result-card-image" style="background-image: url(${restaurant.imgurl});"><i class="fa fa-star"></i></div>
                    <div class="result-card-desc">
                        <h1><a target='_blank' href="${restaurant.url}">${restaurant.name}</a> </h1>
                        <h2>${restaurant.address}</h2>
                        <div class="stars-container">
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <i class="fa fa-star"></i>
                    <p class="stars-counter">${restaurant.rating} (${restaurant.rcount})</p>
                </div>
                        <h3>${restaurant.reason}</h3>
                    </div>
                `;
                restaurantCardsDiv.appendChild(card);
            });
        }
    </script>

{% endblock %}
